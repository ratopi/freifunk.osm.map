<html>
<head>

	<title>Freifunk Map</title>

	<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.css" />
	<!--[if lte IE 8]>
	<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.ie.css" />
	<![endif]-->

</head>
<body>

<div id="map" style="height:800px;border:1px solid black;"></div>

<script type="text/javascript" src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
<script src="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.js"></script>
<script>
	var map = L.map( 'map' ); // .setView( [ 51.505, -0.09 ], 13 );

	L.tileLayer(
		// 'http://{s}.tile.cloudmade.com/3249f584dd674d399238a99850abcbae/997/256/{z}/{x}/{y}.png',
		// 'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
		'http://{s}.tile.openstreetmap.de/tiles/osmde/{z}/{x}/{y}.png',
		{
			attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery &copy; <a href="http://openstreetmap.org">OpenStreetMap</a>',
			maxZoom: 18
		}
	).addTo( map );

	// ---

	var ffIcon = L.icon(
		{
			iconUrl: 'img/Freifunk-Marker-1-30.png',
			// shadowUrl: 'leaf-shadow.png',

			iconSize:     [ 30, 30 ], // size of the icon
			iconAnchor:   [ 15, 15 ], // point of the icon which will correspond to marker's location
			// shadowSize:   [50, 64], // size of the shadow
			// shadowAnchor: [4, 62],  // the same for the shadow
			popupAnchor:  [ 0, 0 ] // point from which the popup should open relative to the iconAnchor
		}
	);

	// ---

	var counter = 0;
	var latSum = 0;
	var lonSum = 0;
	$.getJSON(
		"data/directory.json",
		function( data )
		{
			for ( var k in data )
			{
				$.getJSON(
					"data/" + k + ".json",
					function( x )
					{
						var marker = L.marker(
							[ x.location.lat, x.location.lon ],
							{
								icon: ffIcon,
								riseOnHover: true,
								title: x.name
							}
						).addTo( map );

						marker.bindPopup( x.name );

						// automatition for centering the map ... ;-)
						counter++;
						latSum += x.location.lat;
						lonSum += x.location.lon;

						map.setView( [ ( latSum / counter), ( lonSum / counter) ], 6 );
					}
				);
			}
		}
	);


</script>
</body>
</html>
